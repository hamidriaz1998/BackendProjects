{% extends "base.html" %} {% block title %}Edit Article - My Blog{% endblock %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h3 class="mb-0"><i class="fas fa-edit"></i> Edit Article</h3>
            </div>
            <div class="card-body p-4">
                <form
                    method="post"
                    action="/article/edit/{{ article.id }}"
                    id="editArticleForm"
                >
                    <input type="hidden" name="_method" value="PUT" />

                    <div class="mb-4">
                        <label for="title" class="form-label">
                            <i class="fas fa-heading"></i> Article Title
                        </label>
                        <input
                            type="text"
                            class="form-control"
                            id="title"
                            name="title"
                            required
                            value="{{ article.title }}"
                            placeholder="Enter an engaging title for your article"
                            maxlength="255"
                        />
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i>
                            Make it catchy and descriptive (max 255 characters)
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="content" class="form-label">
                            <i class="fas fa-file-alt"></i> Content
                        </label>
                        <textarea id="content" name="content">
{{ article.content }}</textarea
                        >
                        <div class="form-text">
                            <i class="fas fa-markdown"></i>
                            Use Markdown syntax for formatting. Preview your
                            content using the toolbar above.
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <div>
                            <a href="/" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancel
                            </a>
                            <a
                                href="/article/{{ article.id }}"
                                class="btn btn-outline-primary ms-2"
                            >
                                <i class="fas fa-eye"></i> View Article
                            </a>
                        </div>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-save"></i> Update Article
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Article Info Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle"></i> Article Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p>
                            <strong>Original Publication Date:</strong><br />
                            <i class="fas fa-calendar-alt text-primary"></i> {{
                            article.publishing_date.strftime('%B %d, %Y') }}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p>
                            <strong>Article ID:</strong><br />
                            <i class="fas fa-hashtag text-primary"></i> {{
                            article.id }}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Markdown Help Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-question-circle"></i> Markdown Quick
                    Reference
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-heading"></i> Headers</h6>
                        <code># H1<br />## H2<br />### H3</code>

                        <h6 class="mt-3">
                            <i class="fas fa-bold"></i> Text Formatting
                        </h6>
                        <code>**bold**<br />*italic*<br />`code`</code>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-list"></i> Lists</h6>
                        <code
                            >- Item 1<br />- Item 2<br /><br />1. Numbered<br />2.
                            List</code
                        >

                        <h6 class="mt-3">
                            <i class="fas fa-link"></i> Links & Images
                        </h6>
                        <code>[Link](url)<br />![Image](url)</code>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block extra_scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Initialize SimpleMDE
        const simplemde = new SimpleMDE({
            element: document.getElementById("content"),
            spellChecker: false,
            status: ["autosave", "lines", "words", "cursor"],
            toolbar: [
                "bold",
                "italic",
                "heading",
                "|",
                "quote",
                "unordered-list",
                "ordered-list",
                "|",
                "link",
                "image",
                "|",
                "code",
                "table",
                "|",
                "preview",
                "side-by-side",
                "fullscreen",
                "|",
                "guide",
            ],
            autofocus: false,
            tabSize: 4,
            indentWithTabs: false,
            lineWrapping: true,
            styleSelectedText: true,
            shortcuts: {
                drawTable: "Cmd-Alt-T",
                toggleBlockquote: "Cmd-'",
                toggleBold: "Cmd-B",
                cleanBlock: "Cmd-E",
                toggleHeadingSmaller: "Cmd-H",
                toggleItalic: "Cmd-I",
                drawLink: "Cmd-K",
                toggleUnorderedList: "Cmd-L",
                togglePreview: "Cmd-P",
                toggleCodeBlock: "Cmd-Alt-C",
                toggleOrderedList: "Cmd-Alt-L",
                drawImage: "Cmd-Alt-I",
            },
        });

        // Form validation and submission
        const form = document.getElementById("editArticleForm");
        const titleInput = document.getElementById("title");

        // Character counter for title
        titleInput.addEventListener("input", function () {
            const remaining = 255 - this.value.length;
            const helpText = this.parentElement.querySelector(".form-text");
            if (remaining < 50) {
                helpText.innerHTML = `<i class="fas fa-exclamation-triangle text-warning"></i> ${remaining} characters remaining`;
            } else {
                helpText.innerHTML =
                    '<i class="fas fa-info-circle"></i> Make it catchy and descriptive (max 255 characters)';
            }
        });

        form.addEventListener("submit", function (e) {
            e.preventDefault(); // Always prevent default submission

            const title = titleInput.value.trim();
            const content = simplemde.value().trim();

            if (!title) {
                alert("Please enter a title for your article.");
                titleInput.focus();
                return;
            }

            if (!content) {
                alert("Please write some content for your article.");
                simplemde.codemirror.focus();
                return;
            }

            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Updating...';
            submitBtn.disabled = true;

            const formData = new FormData();
            formData.append("title", title);
            formData.append("content", content);

            fetch(`/article/edit/{{ article.id }}`, {
                method: "PUT",
                body: formData,
                credentials: "include",
            })
                .then((response) => {
                    if (response.ok) {
                        window.location.href = `/article/{{ article.id }}`;
                    } else {
                        throw new Error("Update failed");
                    }
                })
                .catch((error) => {
                    alert("Error updating article. Please try again.");
                    submitBtn.innerHTML =
                        '<i class="fas fa-save"></i> Update Article';
                    submitBtn.disabled = false;
                });
        });

        // Auto-save functionality
        let saveTimeout;
        const autoSave = () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                const title = titleInput.value.trim();
                const content = simplemde.value().trim();

                if (title && content) {
                    localStorage.setItem(
                        "blog_edit_{{ article.id }}_title",
                        title,
                    );
                    localStorage.setItem(
                        "blog_edit_{{ article.id }}_content",
                        content,
                    );
                    console.log("Changes saved automatically");
                }
            }, 2000);
        };

        // Set up auto-save
        titleInput.addEventListener("input", autoSave);
        simplemde.codemirror.on("change", autoSave);

        // Clear auto-save on successful submission
        form.addEventListener("submit", function () {
            localStorage.removeItem("blog_edit_{{ article.id }}_title");
            localStorage.removeItem("blog_edit_{{ article.id }}_content");
        });

        // Warning for unsaved changes
        let hasUnsavedChanges = false;
        const originalTitle = titleInput.value;
        const originalContent = simplemde.value();

        const checkForChanges = () => {
            const currentTitle = titleInput.value;
            const currentContent = simplemde.value();
            hasUnsavedChanges =
                currentTitle !== originalTitle ||
                currentContent !== originalContent;
        };

        titleInput.addEventListener("input", checkForChanges);
        simplemde.codemirror.on("change", checkForChanges);

        window.addEventListener("beforeunload", function (e) {
            if (hasUnsavedChanges) {
                const message =
                    "You have unsaved changes. Are you sure you want to leave?";
                e.returnValue = message;
                return message;
            }
        });
    });
</script>
{% endblock %}
